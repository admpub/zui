/*!
 * ZUI: 流程图 - v1.9.1 - 2019-07-26
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2019 cnezsoft.com; Licensed MIT
 */
!function(t){"use strict";var e=function(t){var e,o=document,i=t[0];if(o.body.createTextRange)e=document.body.createTextRange(),e.moveToElementText(i),e.select();else if(window.getSelection){var n=window.getSelection();e=document.createRange(),e.selectNodeContents(i),n.removeAllRanges(),n.addRange(e)}},o="zui.flowChart",i=function(e,n){var r=this;r.name=o,r.idSeed=0;var d=r.$container=t(e).addClass("scrollbar-hover").css("overflow","auto");r.id=d.attr("id")||"flowchart_"+t.zui.uuid(),n=r.options=t.extend({},i.DEFAULTS,d.data(),n);var a=t.extend({},i.LANGS,n.langs),l=n.lang||(t.zui&&t.zui.clientLang?t.zui.clientLang():"en");r.lang=a[l.replace("_","-")]||a.en;var s=d.children(".flowchart-canvas");s.length||(s=t('<div class="flowchart-canvas" style="position: relative; user-select: none"></div>').appendTo(d));var h="flowchart-canvas-"+r.id;if(s.attr("id",h),r.$canvas=s,void 0!==n.width&&d.css("width",n.width),void 0!==n.height&&d.css("height",n.height),r.draggableEnable=n.draggable&&t.fn.draggable,r.draggableEnable){var c=function(e){r.setNodePosition(t(e.element).data("id"),e.pos)};s.draggable({container:"#"+h,selector:".flowchart-node",stopPropagation:!0,drag:c,finish:c,mouseButton:"left"})}r.elements={},r.update(n.data),n.doubleClickToEdit&&s.on("dblclick",".flowchart-node,.flowchart-relation-text",function(e){var o=t(this).closest(".flowchart-node,.flowchart-relation");r.enterEditMode(o.data("id")),e.preventDefault()}),n.showContextMenu&&t.zui.ContextMenu&&s.on("mousedown",".flowchart-node,.flowchart-relation",function(e){2===e.button&&r.showContextMenu(t(this).data("id"),e),e.preventDefault(),e.returnValue=!1}).on("contextmenu",function(t){return t.preventDefault(),t.returnValue=!1,!1}),n.quickAdd&&s.on("mouseenter",".flowchart-node",function(){r.showQuickAdd(t(this).data("id"))}).on("mouseleave",".flowchart-node",function(){r.hideQuickAdd()}).on("click",".flowchart-quick-mark",function(){var e=t(this);r.quickAddNode(e.closest(".flowchart-node").data("id"),e.data("direction"))})};i.prototype.showQuickAdd=function(e){var o=this;if("string"==typeof e&&(e=o.elements[e]),e){var i=e.$ele.find(".flowchart-quick-marks");i.length||(i=t(['<div class="flowchart-quick-marks" style="position: absolute; left: -15px; top: -15px; right: -15px; bottom: -15px; pointer-events: none; z-index: 10">','<div class="flowchart-quick-mark" data-direction="top" style="position: absolute; pointer-events: auto; width: 20px; height: 20px; top: 0; left: 50%; margin-left: -10px; line-height: 20px; text-align: center; cursor: pointer; border-radius: 50%; background: #fff; background: rgba(255,255,255,.9)"><i class="icon icon-circle-arrow-up text-primary"></i></div>','<div class="flowchart-quick-mark" data-direction="right" style="position: absolute; pointer-events: auto; width: 20px; height: 20px; right: 0; top: 50%; margin-top: -10px; line-height: 20px; text-align: center; cursor: pointer; border-radius: 50%; background: #fff; background: rgba(255,255,255,.9)"><i class="icon icon-circle-arrow-right text-primary"></i></div>','<div class="flowchart-quick-mark" data-direction="bottom" style="position: absolute; pointer-events: auto; width: 20px; height: 20px; bottom: 0; left: 50%; margin-left: -10px; line-height: 20px; text-align: center; cursor: pointer; border-radius: 50%; background: #fff; background: rgba(255,255,255,.9)"><i class="icon icon-circle-arrow-down text-primary"></i></div>','<div class="flowchart-quick-mark" data-direction="left" style="position: absolute; pointer-events: auto; width: 20px; height: 20px; left: 0; top: 50%; margin-top: -10px; line-height: 20px; text-align: center; cursor: pointer; border-radius: 50%; background: #fff; background: rgba(255,255,255,.9)"><i class="icon icon-circle-arrow-left text-primary"></i></div>',"</div>"].join("")).appendTo(e.$ele)),i.show().children().show();var n=o.options;e.bounds.left<n.padding+80+n.horzSpace&&i.find('[data-direction="left"]').hide(),e.bounds.top<n.padding+n.nodeHeight+n.vertSpace&&i.find('[data-direction="top"]').hide(),o._currentQuickAddNode=e}},i.prototype.hideQuickAdd=function(){var t=this,e=t._currentQuickAddNode;e&&(e.$ele.find(".flowchart-quick-marks").hide(),t._currentQuickAddNode=null)},i.prototype.quickAddNode=function(e,o){var i=this;if("string"==typeof e&&(e=i.elements[e]),e){var n=t.zui.uuid();i.update({id:n,text:"",direction:o,directionFrom:e,from:e.id}),i.enterEditMode(n)}},i.prototype.showContextMenu=function(e,o){var i=this;if("string"==typeof e&&(e=i.elements[e]),e){var n=null;return n="function"==typeof i.options.showContextMenu?i.options.showContextMenu(e,o):[{label:i.lang.edit,onClick:function(){i.enterEditMode(e)}},{label:i.lang["delete"],onClick:function(){i.options.deleteConfirm&&!confirm(i.lang.confirmToDelete.format(e.text||e.id))||i["delete"](e.id)}}],n&&n.length?(t.zui.ContextMenu.show(n,{event:o}),!0):void 0}},i.prototype.renderNode=function(e,o){var i=this,n=i.options,r=t(i._getDomID(e));r.length||(r=t('<div id="'+i._getDomID(e,1)+'" style="z-index: 1" class="flowchart-node" data-id="'+e.id+'" data-type="'+e.type+'"><div class="text" style="outline: none; min-width: 10px; min-height: 20px;"></div></div>').appendTo(i.$canvas),i.draggableEnable&&r.css("cursor","move")),r.addClass(e.className);var d=r.find(".text");d.css(n.nodeTextStyle).text(void 0===e.text||null===e.text?"":e.text),e.$ele=r,e.position&&!e.customPos&&(e.position=null);var a=t.extend({display:"flex",justifyContent:"center",alignItems:"center",maxHeight:n.nodeHeight,minWidth:0},n.nodeStyle,n[e.type+"NodeStyle"],e.style,e.position,{position:"absolute",visibility:e.position?"visible":"hidden"});r.css(a),e.size={width:r.outerWidth(),height:r.outerHeight()},o||this._layoutNode(e)},i.prototype._layoutNode=function(e){var o=this,i=e.$ele,n=o.bounds,r=e.size,d=e.position,a=o.options.adsorptionGrid;if(a===!0&&(a=5),r.width=Math.ceil(r.width/(2*a))*a*2,!d||!e.customPos){var l=o.options,s=e.parents,h=e.direction,c=e.directionFrom;d=e.position={};var p={top:1,left:1,bottom:1,right:1};if(h&&p[h]&&c){var f=c.bounds;"top"===h?(d.left=Math.floor(f.centerLeft-r.width/2),d.top=f.top-l.vertSpace-r.height):"left"===h?(d.left=f.left-l.horzSpace-r.width,d.top=Math.floor(f.centerTop-r.height/2)):"bottom"===h?(d.left=Math.floor(f.centerLeft-r.width/2),d.top=f.bottom+l.vertSpace):"right"===h&&(d.left=f.right+l.horzSpace,d.top=Math.floor(f.centerTop-r.height/2))}else if(s.length){var u={left:l.padding,top:l.padding,right:l.padding,bottom:l.padding},g=0;t.each(s,function(i,n){if(n.position||o._layoutNode(n),0===i){var r=n.position,d=n.size;u.left=Math.min(u.left,r.left),u.top=Math.min(u.top,r.top),u.right=Math.max(u.right,d.width+r.left),u.bottom=Math.max(u.bottom,d.height+r.top)}if(void 0===e.siblingsIndex){var a=n.children;a.length&&t.each(a,function(t,e){void 0===e.siblingsIndex&&(e.siblingsIndex=g++)})}}),d.left=u.right+l.horzSpace,d.top=u.top+e.siblingsIndex*(l.nodeHeight+l.vertSpace)}else d.left=n.left+n.width+(n.left<=l.padding?0:l.horzSpace),d.top=n.top+n.height+(n.top<=l.padding?0:l.vertSpace);l.disableAutoPosition&&(e.customPos=!0)}e.direction&&delete e.direction,e.directionFrom&&delete e.directionFrom,a&&(d.left=Math.round(d.left/a)*a,d.top=Math.round(d.top/a)*a),i.css({visibility:"visible",left:d.left,top:d.top,minWidth:r.width}),n.left=Math.min(n.left,d.left),n.top=Math.min(n.top,d.top),n.width=Math.max(n.width,d.left+r.width),n.height=Math.max(n.height,d.top+r.height);var v=d.left+r.width/2,m=d.top+r.height/2,x=Math.sqrt(v*v+m*m);e.bounds={left:d.left,top:d.top,width:r.width,height:r.height,right:d.left+r.width,bottom:d.top+r.height,centerLeft:v,centerTop:m,centerDistance:x}},i.prototype.renderRelation=function(e){var o=this,i=o.options,n=t(o._getDomID(e));if(!n.length&&e.visible&&(n=t('<div id="'+o._getDomID(e,1)+'" class="flowchart-relation" data-id="'+e.id+'" data-type="relation" style="z-index: 0; pointer-events: none"><div style="position: absolute; pointer-events: auto" class="flowchart-rel-line flowchart-rel-begin-line"></div><div class="flowchart-rel-line flowchart-rel-center-line" style="position: absolute; pointer-events: auto; display: flex; align-items: center; justify-content: center; white-space: nowrap;"><span class="text flowchart-relation-text" style="background: #fff; background: rgba(255,255,255,.95); position: relative; z-index: 5; line-height: 1; outline: none; pointer-events: auto"></span></div><div style="position: absolute; pointer-events: auto; pointer-events: auto" class="flowchart-rel-line flowchart-rel-end-line"></div><div style="position: absolute; pointer-events: auto" class="flowchart-rel-arrow"></div></div>').appendTo(o.$canvas)),!e.visible)return void n.remove();n.addClass(e.className),e.$ele=n;var r=e.fromNode,d=e.toNode,a=r.bounds,l=d.bounds,s=Math.abs(a.centerTop-l.centerTop)-(a.height+l.height)/2,h=Math.abs(a.centerLeft-l.centerLeft)-(a.width+l.width)/2,c=s>0&&s>h?"vert":"horz",p="horz"===c?l.centerLeft<a.centerLeft:l.centerTop<a.centerTop,f=p?d:r,u=p?r:d,g=f.bounds,v=u.bounds,m={},x={},b={alignItems:"center",justifyContent:"center"},w={},y=i.relationLineColor,M=i.relationLineWidth,T=i.relatinArrowSize,k={position:"absolute",width:0,height:0,borderTopWidth:T/2,borderRightWidth:T/2,borderBottomWidth:T/2,borderLeftWidth:T/2,borderTopColor:"transparent",borderRightColor:"transparent",borderBottomColor:"transparent",borderLeftColor:"transparent",borderStyle:"solid"},S={background:y,position:"absolute"};"horz"===c?(m.left=g.right,m.top=Math.min(g.top,v.top),m.width=v.left-m.left,m.height=Math.max(g.bottom,v.bottom)-m.top,x.left=p?T:0,x.top=Math.floor(g.centerTop-m.top-M/2),x.width=m.width/2-x.left,x.height=M,w.left=m.width/2,w.top=Math.floor(v.centerTop-m.top-M/2),w.width=m.width/2-(p?0:T),w.height=M,b.left=Math.floor(m.width/2-M/2),b.top=Math.floor(Math.min(v.centerTop,g.centerTop)-m.top-M/2),b.height=Math.floor(Math.abs(v.centerTop-g.centerTop)+M),b.width=M,i.showRelationTextOnSide&&(b.height<=10?b.alignItems="flex-end":(b.justifyContent="flex-start",b.textIndent="4px")),p?(k.borderRightWidth=T,k.borderLeftWidth=0,k.borderRightColor=y,k.left=0,k.top=Math.floor(x.top+M/2-T/2)):(k.borderLeftWidth=T,k.borderRightWidth=0,k.borderLeftColor=y,k.left=w.left+w.width,k.top=Math.floor(w.top+M/2-T/2))):(m.left=Math.min(g.left,v.left),m.top=g.bottom,m.width=Math.max(g.right,v.right)-m.left,m.height=v.top-m.top,x.top=p?T:0,x.left=Math.floor(g.centerLeft-m.left-M/2),x.height=m.height/2-x.top,x.width=M,w.top=m.height/2,w.left=Math.floor(v.centerLeft-m.left-M/2),w.height=m.height/2-(p?0:T),w.width=M,b.top=Math.floor(m.height/2-M/2),b.left=Math.floor(Math.min(v.centerLeft,g.centerLeft)-m.left-M/2),b.width=Math.floor(Math.abs(v.centerLeft-g.centerLeft)+M),b.height=M,i.showRelationTextOnSide&&(b.width<=10?(b.justifyContent="flex-start",b.textIndent="4px"):b.alignItems="flex-end"),p?(k.borderBottomWidth=T,k.borderTopWidth=0,k.borderBottomColor=y,k.top=0,k.left=Math.floor(x.left+M/2-T/2)):(k.borderTopWidth=T,k.borderBottomWidth=0,k.borderTopColor=y,k.top=w.top+w.height,k.left=Math.floor(w.left+M/2-T/2))),n.find(".flowchart-rel-arrow").css(k),n.find(".flowchart-rel-begin-line").css(t.extend(x,S)),n.find(".flowchart-rel-end-line").css(t.extend(w,S));var C=n.find(".flowchart-rel-center-line").css(t.extend(b,S)),R=void 0===e.text||null===e.text?"":e.text;i.showRelationTextOnSide?C.text(R):C.find(".text").css(t.extend({},i.relationTextStyle)).text(R),n.css(t.extend({position:"absolute"},m))},i.prototype.render=function(e){var o=this,i=o.options,n=o.elements,r=[],d=[];t.each(n,function(t,e){"relation"===e.type?d.push(e):(delete e.siblingsIndex,e.fromRels=[],e.toRels=[],e.children=[],e.parents=[],r.push(e))});var a=function(t,e){return t.order-e.order};r.sort(a),d.sort(a),t.each(d,function(t,e){var o=n[e.from],i=n[e.to];e.visible=o&&i,e.visible&&(e.fromIndex=o.fromRels.length,e.toIndex=o.toRels.length,e.fromNode=o,e.toNode=i,o.fromRels.push(e),i.toRels.push(e),o.children.push(i),i.parents.push(o))});var l=e?{}:null;e?(t.isArray(e)||(e=[e]),t.each(e,function(e,o){"object"==typeof o&&(o=o.id);var i=n[o];i&&(l[o]=i,"relation"!==i.type&&(i.fromRels.length&&t.each(i.fromRels,function(t,e){l[e.id]=e}),i.toRels.length&&t.each(i.toRels,function(t,e){l[e.id]=e})))})):o.bounds={left:i.padding,top:i.padding,width:0,height:0},t.each(r,function(t,e){l&&!l[e.id]||o.renderNode(e,!0)}),t.each(r,function(t,e){l&&!l[e.id]||o._layoutNode(e)}),t.each(d,function(t,e){l&&!l[e.id]||o.renderRelation(e)}),o.$canvas.css({minWidth:o.bounds.width+i.padding,minHeight:o.bounds.height+i.padding})},i.prototype.setNodePosition=function(t,e){var o=this,i=o.elements[t];i&&(i.position={left:"number"==typeof e.left?e.left:i.position.left,top:"number"==typeof e.top?e.top:i.position.top},i.customPos=!0,o.render(i))},i.prototype.resetPosition=function(){t.each(this.elements,function(t,e){"relation"!==e.type&&e.customPos&&delete e.customPos}),this.render()},i.prototype.enterEditMode=function(t){var o=this;if("string"==typeof t&&(t=o.elements[t]),t){o.exitEditMode();var i=t.$ele,n=t.isRelation?i.find(".flowchart-relation-text"):i;t.styleBeforeEdit={zIndex:n.css("zIndex"),borderColor:n.css("borderColor"),boxShadow:n.css("boxShadow"),paddingLeft:n.css("paddingLeft"),paddingRight:n.css("paddingRight")},n.css({zIndex:10,borderColor:"#3280fc",boxShadow:"0 0 2px #3280fc, 0 0 0 2px rgba(50,128,252,.2)",paddingLeft:4,paddingRight:4});var r=t.isRelation?n:i.find(".text");r.attr("contenteditable","true").focus().one("blur."+o.id,function(){o.exitEditMode()}),e(r),o._currentEditEle=t}},i.prototype.exitEditMode=function(){var t=this,e=t._currentEditEle;if(e){var o=e.$ele,i=e.isRelation?o.find(".flowchart-relation-text"):o,n=e.isRelation?i:o;i.css(e.styleBeforeEdit),n.attr("contenteditable"," ").off("."+t.id),t._currentEditEle=null,t.editNodeText(e,n.text())}},i.prototype.editNodeText=function(t,e,o){"string"==typeof t&&(t=this.elements[t]),t&&(void 0!==t.text&&void 0===t.originText&&(t.originText=t.text),t.text=e,o||this.render(t))},i.prototype.resetData=function(e){e||(e=[{id:"start",type:"start",text:"Start"}]);var o=this,i=[];t.each(o.elements,function(t,e){i.push(e)}),o["delete"](i,!0),o.update(e)},i.prototype.update=function(e,o){if("object"!=typeof e||t.isArray(e)||(e=[e]),e&&e.length){var i=this,n=i.elements;t.each(e,function(e,o){var r=o.id;if(o.isRelation="relation"===o.type,o.isNode=!o.isRelation,void 0===r&&(r=o.isRelation?o.from+"-"+o.to:t.zui.uuid(),o.id=r),o.type||(o.type="action"),o.position&&(o.customPos=!0),o.isNode){var d=[];if(o.from){var a=t.isArray(o.from)?o.from:[o.from];t.each(a,function(t,e){var o=e.split(":");d.push({type:"relation",from:o[0],to:r,text:o[1],id:o[0]+"-"+r})}),delete o.from}if(o.to){var l=t.isArray(o.to)?o.to:[o.to];t.each(l,function(t,e){var o=e.split(":");d.push({type:"relation",to:o[0],text:o[1],from:r,id:r+"-"+o[0]})}),delete o.to}d.length&&i.update(d,!0)}var s=n[r];s?(o.order=s.order,o.position||(o.position=s.position)):(o.order=i.idSeed++,o.isRelation&&(o.order+=1e6)),n[r]=o}),o||i.render()}},i.prototype._getDomID=function(t,e){return(e?"":"#")+this.id+"-"+("string"==typeof t?t:t.id)},i.prototype["delete"]=function(e,o){var i=this;"string"==typeof e&&(e=[e]),t.each(e,function(t,e){"object"==typeof e&&(e=e.id);var o=i.$canvas.find(i._getDomID(e));o.remove(),delete i.elements[e]}),o||i.render()},i.prototype.exportData=function(){var e=[];return t.each(this.elements,function(t,o){var i={id:o.id,type:o.type,order:o.order};"relation"===o.type?(i.from=o.from,i.to=o.to):o.customPos&&(i.position=o.position),void 0!==o.text&&(i.text=o.text),void 0!==o.className&&(i.className=o.className),void 0!==o.style&&(i.style=o.style),e.push(i)}),e.sort(function(t,e){return t.order-e.order}),t.each(e,function(t,e){delete e.order}),e},i.prototype.setOptions=function(e,o){t.extend(this.options,e),o||this.render()},i.LANGS={"zh-cn":{confirmToDelete:"确定删除【{0}】？",edit:"编辑","delete":"删除"},"zh-tw":{confirmToDelete:"確定刪除【{0}】？",edit:"編輯","delete":"刪除"},en:{confirmToDelete:'Confirm to delete "{0}"?',edit:"Edit","delete":"Delete"}},i.DEFAULTS={adsorptionGrid:5,doubleClickToEdit:!0,showContextMenu:!0,disableAutoPosition:!0,quickAdd:!0,deleteConfirm:!0,width:"auto",height:500,padding:20,nodeHeight:40,horzSpace:80,vertSpace:60,relatinArrowSize:8,relationLineWidth:1,relationLineColor:"#333",nodeStyle:{border:"1px solid #333",maxWidth:200,minWidth:70,background:"white",padding:"9px 10px"},actionNodeStyle:{borderRadius:"2px"},startNodeStyle:{borderRadius:"20px"},stopNodeStyle:{borderRadius:"20px"},nodeTextStyle:{whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},relationTextStyle:{},showRelationTextOnSide:!1,data:[{id:"start",type:"start",text:"Start"}],draggable:!0},t.fn.flowChart=function(e){return this.each(function(){var n=t(this),r=n.data(o),d="object"==typeof e&&e;r||n.data(o,r=new i(this,d)),"string"==typeof e&&r[e]()})},i.NAME=o,t.fn.flowChart.Constructor=i,t(function(){t('[data-ride="flowChart"]').flowChart()})}(jQuery);